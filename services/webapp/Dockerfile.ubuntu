#################################################
# BUILDER  PYTHON 3.8.2 ON MACHINE UBUNTU 18.04 #---------------------------------------------------
#################################################

# pull official base image
FROM ubuntu:19.10 as builder


# install system utilities
ENV DEBIAN_FRONTEND noninteractive
ENV LANG C.UTF-8
ENV LC_ALL C.UTF-8
# install SQL Server drivers
RUN apt-get update && apt-get install -y --fix-missing \
  curl gnupg apt-utils apt-transport-https build-essential debconf-utils \
  ca-certificates openssl libssl-dev \
  python3-dev python3-pip python3-wheel

RUN curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - 
RUN curl https://packages.microsoft.com/config/ubuntu/19.10/prod.list > /etc/apt/sources.list.d/mssql-release.list
RUN apt-get update && ACCEPT_EULA=Y apt-get install -y msodbcsql17 locales \
  # update locale-gen for mssql
  && echo "en_US.UTF-8 UTF-8" > /etc/locale.gen \
  && locale-gen \
  # update openssl to ssl1.1 for pyodbc
  && chmod +rwx /etc/ssl/openssl.cnf \
  && sed -i 's/TLSv1.2/TLSv1/g' /etc/ssl/openssl.cnf \
  && sed -i 's/SECLEVEL=2/SECLEVEL=1/g' /etc/ssl/openssl.cnf \
 # clean
  && apt-get autoremove -y\
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*


# install python env
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
RUN python3 --version && python3 -m pip --version \
  && python3 -m pip install --upgrade pip wheel
# lint
# RUN python3 -m pip install --upgrade flake8 black

# install dependencies
WORKDIR /complier
COPY ./reqs_ubuntu.txt ./reqs.txt
RUN python3 -m pip wheel --no-cache-dir --no-deps --wheel-dir /complier/wheels -r reqs.txt
#RUN python3 -m pip wheel --wheel-dir /complier/wheels -r reqs.txt


# check lint
# COPY . .
# RUN flake8 --ignore=E501,F401 . && black --check .


#########
# FINAL #----------------------------------------------------------------------------------
#########

# pull official base image
FROM ubuntu:19.10


# install system utilities
# SQL Server drivers
COPY --from=builder /etc/apt/trusted.gpg.d /etc/apt/trusted.gpg.d
COPY --from=builder /etc/apt/sources.list.d/mssql-release.list /etc/apt/sources.list.d/mssql-release.list
# locagen
COPY --from=builder /etc/locale.gen /etc/locale.gen
# update openssl to ssl1.1 for pyodbc
COPY --from=builder /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf

ENV DEBIAN_FRONTEND noninteractive
ENV LANG C.UTF-8
ENV LC_ALL C.UTF-8
RUN apt-get update && apt-get install -y --fix-missing --no-install-recommends \
  python3-pyodbc unixodbc-dev ca-certificates openssl libssl-dev \
  python3-dev python3-pip python3-wheel \
  && ACCEPT_EULA=Y apt-get install -y msodbcsql17 \
  && locale-gen \
  # clean
  && apt-get autoremove -y\
  && apt-get clean

# create system user=pkh, group_user=webapp
ENV APP_HOME=/home/web
RUN addgroup --system webapp \
  && adduser --system --home $APP_HOME --shell /bin/false --ingroup webapp --disabled-password --disabled-login pkh

# install webapp
WORKDIR $APP_HOME
COPY --from=builder /complier/wheels /wheels
COPY --from=builder /complier/reqs.txt .
#ENV PYTHONDONTWRITEBYTECODE 1
#ENV PYTHONUNBUFFERED 1
RUN python3 -m pip install --upgrade pip wheel \
  && python3 -m pip install --no-cache /wheels/* \
  # clean all no need
  && rm -rf /wheels \
  && rm -rf /root/.cache/pip/* \
  && rm -rf /var/lib/apt/lists/* \
  && rm -rf /tmp/* \
  && rm -rf /var/tmp/* \
  && apt-get purge -y python3-pip python3-wheel \
  apt-utils apt-transport-https build-essential debconf-utils \
  && apt-get autoremove -y\
  && apt-get clean

# copy project
COPY ../webapp $APP_HOME

# chown all the files to the app user
RUN chown -R pkh:webapp $APP_HOME

# change to the app user
USER pkh

# run one server
EXPOSE 8001
ENTRYPOINT python runserver.py \
  --db_user 'pkh.web' \
  --db_pwd 'w3b@pkh2019' \
  --db_host '192.168.24.4:1433' \
  --db_name 'PKHData' \
  --port 8001